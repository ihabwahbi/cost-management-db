{
  "generated_at": "2025-11-30T13:56:07.740957+00:00",
  "project": "cost-management-db",
  "description": "Data pipeline for transforming raw PO/GR/IR data into import-ready CSVs",
  "pipeline_stages": [
    {
      "name": "stage1_clean",
      "description": "Clean and filter raw data",
      "input_folder": "data/raw",
      "output_folder": "data/intermediate"
    },
    {
      "name": "stage2_transform",
      "description": "Enrich data and calculate derived values",
      "input_folder": "data/intermediate",
      "output_folder": "data/intermediate"
    },
    {
      "name": "stage3_prepare",
      "description": "Map columns to database schema",
      "input_folder": "data/intermediate",
      "output_folder": "data/import-ready"
    }
  ],
  "execution_order": [
    "01_po_line_items",
    "02_gr_postings",
    "03_ir_postings",
    "04_enrich_po_line_items",
    "05_calculate_cost_impact",
    "06_prepare_po_line_items",
    "07_prepare_po_transactions"
  ],
  "scripts": [
    {
      "name": "01_po_line_items",
      "path": "scripts/stage1_clean/01_po_line_items.py",
      "stage": "stage1_clean",
      "docstring": "Stage 1: Clean PO Line Items\n\nReads raw PO line items CSV, applies filtering and transformations,\noutputs to intermediate folder.\n\nDependencies: None (first script in pipeline)\nInput: data/raw/po line items.csv\nOutput: data/intermediate/po_line_items.csv",
      "inputs": [
        "data/raw/po line items.csv",
        "data/intermediate/po_line_items.csv"
      ],
      "outputs": [
        "data/intermediate/po_line_items.csv"
      ],
      "dependencies": [
        "06_prepare_po_line_items"
      ],
      "functions": [
        {
          "name": "load_data",
          "docstring": "Load the raw CSV file.",
          "args": [
            "filepath"
          ],
          "line": 34,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "filter_valuation_classes",
          "docstring": "Remove rows with excluded PO Valuation Classes.",
          "args": [
            "df"
          ],
          "line": 42,
          "semantics": {
            "modifies_columns": [],
            "filters_data": true,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": true
          }
        },
        {
          "name": "filter_nis_levels",
          "docstring": "Remove rows with excluded NIS Level 0 Desc values.",
          "args": [
            "df"
          ],
          "line": 53,
          "semantics": {
            "modifies_columns": [],
            "filters_data": true,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "fill_nis_level_for_3021",
          "docstring": "Set NIS Level 0 Desc to 'Materials and Supplies' for Valuation Class 3021 where null.",
          "args": [
            "df"
          ],
          "line": 63,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": true
          }
        },
        {
          "name": "transform_nis_column",
          "docstring": "Rename NIS Level 0 Desc to NIS Line and clean up values.",
          "args": [
            "df"
          ],
          "line": 73,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": true,
            "type_conversions": false
          }
        },
        {
          "name": "map_vendor_names",
          "docstring": "Map Main Vendor Name and Ultimate Vendor Name based on vendor IDs.",
          "args": [
            "df"
          ],
          "line": 85,
          "semantics": {
            "modifies_columns": [],
            "filters_data": true,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "map_location",
          "docstring": "Map Plant Code to Location.",
          "args": [
            "df"
          ],
          "line": 100,
          "semantics": {
            "modifies_columns": [
              "Location"
            ],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": true
          }
        },
        {
          "name": "consolidate_delivery_dates",
          "docstring": "Consolidate delivery date columns into 'Expected Delivery Date'.",
          "args": [
            "df"
          ],
          "line": 109,
          "semantics": {
            "modifies_columns": [
              "Expected Delivery Date"
            ],
            "filters_data": true,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "save_data",
          "docstring": "Save the cleaned DataFrame to CSV.",
          "args": [
            "df",
            "filepath"
          ],
          "line": 125,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "main",
          "docstring": null,
          "args": [],
          "line": 133,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        }
      ],
      "imports": [
        "sys",
        "pathlib",
        "pandas",
        "config.column_mappings"
      ],
      "pandas_operations": [
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'Location'",
          "column": "Location",
          "line": 103,
          "code_snippet": "df[\"Location\"] = plant_code_str.map(PLANT_CODE_TO_LOCATION)"
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'Expected Delivery Date'",
          "column": "Expected Delivery Date",
          "line": 114,
          "code_snippet": "df[\"Expected Delivery Date\"] = df[promised_col].where("
        },
        {
          "operation": "rename",
          "description": "Renames columns",
          "line": 81,
          "code_snippet": "df = df.rename(columns={\"NIS Level 0 Desc\": \"NIS Line\"})",
          "column_renames": {
            "NIS Level 0 Desc": "NIS Line"
          }
        },
        {
          "operation": "map",
          "description": "Maps values using dictionary or function",
          "line": 89,
          "code_snippet": "df.loc[main_mask, \"Main Vendor Name\"] = df.loc[main_mask, \"Main Vendor ID\"].map(VENDOR_NAME_MAPPING)"
        },
        {
          "operation": "map",
          "description": "Maps values using dictionary or function",
          "line": 94,
          "code_snippet": "df.loc[ultimate_mask, \"Ultimate Vendor Name\"] = df.loc[ultimate_mask, \"Ultimate Vendor Number\"].map(VENDOR_NAME_MAPPING)"
        },
        {
          "operation": "astype",
          "description": "Converts column types",
          "line": 102,
          "code_snippet": "plant_code_str = df[\"Plant Code\"].astype(str)"
        },
        {
          "operation": "map",
          "description": "Maps values using dictionary or function",
          "line": 103,
          "code_snippet": "df[\"Location\"] = plant_code_str.map(PLANT_CODE_TO_LOCATION)"
        },
        {
          "operation": "drop",
          "description": "Removes columns or rows",
          "line": 120,
          "code_snippet": "df = df.drop(columns=[requested_col, promised_col])"
        }
      ],
      "line_count": 173
    },
    {
      "name": "02_gr_postings",
      "path": "scripts/stage1_clean/02_gr_postings.py",
      "stage": "stage1_clean",
      "docstring": "Stage 1: Clean GR (Goods Receipt) Postings\n\nReads raw GR table, filters and calculates GR amounts using unit prices\nfrom intermediate PO line items.\n\nDependencies: 01_po_line_items.py must run first\nInput: data/raw/gr table.csv, data/intermediate/po_line_items.csv\nOutput: data/intermediate/gr_postings.csv",
      "inputs": [
        "data/raw/gr table.csv",
        "data/intermediate/po_line_items.csv",
        "data/intermediate/gr_postings.csv"
      ],
      "outputs": [
        "data/intermediate/po_line_items.csv",
        "data/intermediate/gr_postings.csv"
      ],
      "dependencies": [
        "06_prepare_po_line_items",
        "05_calculate_cost_impact"
      ],
      "functions": [
        {
          "name": "load_data",
          "docstring": "Load the raw CSV file.",
          "args": [
            "filepath"
          ],
          "line": 26,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "filter_zero_quantity",
          "docstring": "Remove rows with zero GR Effective Quantity.",
          "args": [
            "df"
          ],
          "line": 34,
          "semantics": {
            "modifies_columns": [],
            "filters_data": true,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "calculate_gr_amount",
          "docstring": "Calculate GR Amount based on unit price from PO Line Items.\nFormula: GR Amount = (Purchase Value USD / Ordered Quantity) * GR Effective Quantity",
          "args": [
            "df"
          ],
          "line": 43,
          "semantics": {
            "modifies_columns": [
              "Unit Price",
              "GR Amount"
            ],
            "filters_data": false,
            "aggregates": false,
            "joins_data": true,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "save_data",
          "docstring": "Save the cleaned DataFrame to CSV.",
          "args": [
            "df",
            "filepath"
          ],
          "line": 72,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "main",
          "docstring": null,
          "args": [],
          "line": 80,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        }
      ],
      "imports": [
        "sys",
        "pathlib",
        "pandas"
      ],
      "pandas_operations": [
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'Unit Price'",
          "column": "Unit Price",
          "line": 53,
          "code_snippet": "po_df[\"Unit Price\"] = po_df[\"Purchase Value USD\"] / po_df[\"Ordered Quantity\"]"
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'GR Amount'",
          "column": "GR Amount",
          "line": 64,
          "code_snippet": "df[\"GR Amount\"] = (df[\"Unit Price\"] * df[\"GR Effective Quantity\"]).round(2)"
        },
        {
          "operation": "merge",
          "description": "Joins two DataFrames",
          "line": 59,
          "code_snippet": "df = df.merge(unit_price_lookup, on=\"PO Line ID\", how=\"inner\")",
          "on_column": "PO Line ID",
          "join_type": "inner"
        }
      ],
      "line_count": 111
    },
    {
      "name": "03_ir_postings",
      "path": "scripts/stage1_clean/03_ir_postings.py",
      "stage": "stage1_clean",
      "docstring": "Stage 1: Clean IR (Invoice Receipt) Postings\n\nReads raw invoice table, calculates invoice amounts using unit prices\nfrom intermediate PO line items.\n\nDependencies: 01_po_line_items.py must run first\nInput: data/raw/invoice table.csv, data/intermediate/po_line_items.csv\nOutput: data/intermediate/ir_postings.csv",
      "inputs": [
        "data/raw/invoice table.csv",
        "data/intermediate/po_line_items.csv",
        "data/intermediate/ir_postings.csv"
      ],
      "outputs": [
        "data/intermediate/po_line_items.csv",
        "data/intermediate/ir_postings.csv"
      ],
      "dependencies": [
        "06_prepare_po_line_items",
        "05_calculate_cost_impact"
      ],
      "functions": [
        {
          "name": "load_data",
          "docstring": "Load the raw CSV file.",
          "args": [
            "filepath"
          ],
          "line": 26,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "calculate_invoice_amount",
          "docstring": "Calculate Invoice Amount based on unit price from PO Line Items.\nFormula: Invoice Amount = (Purchase Value USD / Ordered Quantity) * IR Effective Quantity",
          "args": [
            "df"
          ],
          "line": 34,
          "semantics": {
            "modifies_columns": [
              "Unit Price",
              "Invoice Amount"
            ],
            "filters_data": false,
            "aggregates": false,
            "joins_data": true,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "save_data",
          "docstring": "Save the cleaned DataFrame to CSV.",
          "args": [
            "df",
            "filepath"
          ],
          "line": 63,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "main",
          "docstring": null,
          "args": [],
          "line": 71,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        }
      ],
      "imports": [
        "sys",
        "pathlib",
        "pandas"
      ],
      "pandas_operations": [
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'Unit Price'",
          "column": "Unit Price",
          "line": 44,
          "code_snippet": "po_df[\"Unit Price\"] = po_df[\"Purchase Value USD\"] / po_df[\"Ordered Quantity\"]"
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'Invoice Amount'",
          "column": "Invoice Amount",
          "line": 55,
          "code_snippet": "df[\"Invoice Amount\"] = (df[\"Unit Price\"] * df[\"IR Effective Quantity\"]).round(2)"
        },
        {
          "operation": "merge",
          "description": "Joins two DataFrames",
          "line": 50,
          "code_snippet": "df = df.merge(unit_price_lookup, on=\"PO Line ID\", how=\"inner\")",
          "on_column": "PO Line ID",
          "join_type": "inner"
        }
      ],
      "line_count": 99
    },
    {
      "name": "04_enrich_po_line_items",
      "path": "scripts/stage2_transform/04_enrich_po_line_items.py",
      "stage": "stage2_transform",
      "docstring": "Stage 2: Enrich PO Line Items\n\nEnriches intermediate PO line items with PR Number and Requester\nfrom the PO Details Report.\n\nDependencies: 01_po_line_items.py must run first\nInput: data/intermediate/po_line_items.csv, data/raw/po details report.xlsx\nOutput: data/intermediate/po_line_items.csv (updated in place)",
      "inputs": [
        "data/raw/po details report.xlsx",
        "data/intermediate/po_line_items.csv"
      ],
      "outputs": [
        "data/intermediate/po_line_items.csv"
      ],
      "dependencies": [
        "06_prepare_po_line_items"
      ],
      "functions": [
        {
          "name": "load_po_details",
          "docstring": "Load PO Details Report and prepare for join.",
          "args": [
            "filepath"
          ],
          "line": 25,
          "semantics": {
            "modifies_columns": [
              "PO Line Item",
              "PO Line ID"
            ],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": true
          }
        },
        {
          "name": "load_po_line_items",
          "docstring": "Load intermediate PO line items.",
          "args": [
            "filepath"
          ],
          "line": 38,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "extract_enrichment_data",
          "docstring": "Extract Requester and PR Number from PO Details.",
          "args": [
            "details"
          ],
          "line": 46,
          "semantics": {
            "modifies_columns": [
              "PO Line ID",
              "Requester",
              "PR Number"
            ],
            "filters_data": true,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "enrich_data",
          "docstring": "Left join enrichment data to PO line items.",
          "args": [
            "po_df",
            "enrichment"
          ],
          "line": 73,
          "semantics": {
            "modifies_columns": [],
            "filters_data": true,
            "aggregates": false,
            "joins_data": true,
            "renames_columns": false,
            "type_conversions": true
          }
        },
        {
          "name": "save_data",
          "docstring": "Save enriched DataFrame to CSV.",
          "args": [
            "df",
            "filepath"
          ],
          "line": 108,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "main",
          "docstring": null,
          "args": [],
          "line": 115,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        }
      ],
      "imports": [
        "sys",
        "pathlib",
        "pandas"
      ],
      "pandas_operations": [
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'PO Line Item'",
          "column": "PO Line Item",
          "line": 32,
          "code_snippet": "df['PO Line Item'] = df['PO Line Item'].fillna(0).astype(int)"
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'PO Line ID'",
          "column": "PO Line ID",
          "line": 33,
          "code_snippet": "df['PO Line ID'] = df['PO Number'].astype(str) + '-' + df['PO Line Item'].astype(str)"
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'PO Line ID'",
          "column": "PO Line ID",
          "line": 51,
          "code_snippet": "enrichment['PO Line ID'] = details['PO Line ID']"
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'Requester'",
          "column": "Requester",
          "line": 54,
          "code_snippet": "enrichment['Requester'] = details['ARIBA shopping cart number : created by (Text)']"
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'PR Number'",
          "column": "PR Number",
          "line": 64,
          "code_snippet": "enrichment['PR Number'] = pr_number.where(pr_number.notna(), ariba_number)"
        },
        {
          "operation": "astype",
          "description": "Converts column types",
          "line": 32,
          "code_snippet": "df['PO Line Item'] = df['PO Line Item'].fillna(0).astype(int)"
        },
        {
          "operation": "apply",
          "description": "Applies function to data",
          "line": 61,
          "code_snippet": "pr_number = pr_number.apply(lambda x: str(int(x)) if pd.notna(x) else None)"
        },
        {
          "operation": "apply",
          "description": "Applies function to data",
          "line": 62,
          "code_snippet": "ariba_number = ariba_number.apply(lambda x: str(x) if pd.notna(x) else None)"
        },
        {
          "operation": "merge",
          "description": "Joins two DataFrames",
          "line": 80,
          "code_snippet": "enriched = po_df.merge(",
          "on_column": "PO Line ID",
          "join_type": "left"
        },
        {
          "operation": "astype",
          "description": "Converts column types",
          "line": 89,
          "code_snippet": "pr_str = enriched['PR Number'].astype(str)"
        },
        {
          "operation": "astype",
          "description": "Converts column types",
          "line": 33,
          "code_snippet": "df['PO Line ID'] = df['PO Number'].astype(str) + '-' + df['PO Line Item'].astype(str)"
        },
        {
          "operation": "fillna",
          "description": "Fills null values",
          "line": 32,
          "code_snippet": "df['PO Line Item'] = df['PO Line Item'].fillna(0).astype(int)"
        },
        {
          "operation": "astype",
          "description": "Converts column types",
          "line": 33,
          "code_snippet": "df['PO Line ID'] = df['PO Number'].astype(str) + '-' + df['PO Line Item'].astype(str)"
        }
      ],
      "line_count": 151
    },
    {
      "name": "05_calculate_cost_impact",
      "path": "scripts/stage2_transform/05_calculate_cost_impact.py",
      "stage": "stage2_transform",
      "docstring": "Stage 2: Calculate Cost Impact\n\nCalculates cost impact from GR and IR postings for each PO Line Item.\nTwo types: Simple (GLD + K/P/S/V) uses GR only, Complex uses GR/IR logic.\n\nDependencies: All stage1 scripts must run first\nInput: data/intermediate/po_line_items.csv, gr_postings.csv, ir_postings.csv\nOutput: data/intermediate/cost_impact.csv",
      "inputs": [
        "data/intermediate/po_line_items.csv",
        "data/intermediate/gr_postings.csv",
        "data/intermediate/ir_postings.csv",
        "data/intermediate/cost_impact.csv"
      ],
      "outputs": [
        "data/intermediate/po_line_items.csv",
        "data/intermediate/gr_postings.csv",
        "data/intermediate/ir_postings.csv",
        "data/intermediate/cost_impact.csv"
      ],
      "dependencies": [
        "06_prepare_po_line_items",
        "07_prepare_po_transactions"
      ],
      "functions": [
        {
          "name": "load_data",
          "docstring": "Load all required data files.",
          "args": [],
          "line": 31,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "classify_po_line_items",
          "docstring": "Classify PO Line Items into simple (Type 1) and complex (Type 2).\n\nType 1 (Simple): Vendor Category = GLD AND Account Category IN (K, P, S, V)\nType 2 (Complex): All others",
          "args": [
            "po_df"
          ],
          "line": 47,
          "semantics": {
            "modifies_columns": [],
            "filters_data": true,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "calculate_simple_cost_impact",
          "docstring": "Type 1: Cost impact = GR postings only (IR ignored).",
          "args": [
            "gr_df",
            "simple_po_ids"
          ],
          "line": 68,
          "semantics": {
            "modifies_columns": [],
            "filters_data": true,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "calculate_complex_cost_impact",
          "docstring": "Type 2: Cost impact based on GR/IR chronological processing.",
          "args": [
            "gr_df",
            "ir_df",
            "complex_po_ids",
            "po_df"
          ],
          "line": 87,
          "semantics": {
            "modifies_columns": [
              "Posting Type",
              "Posting Date",
              "Unit Price"
            ],
            "filters_data": true,
            "aggregates": true,
            "joins_data": false,
            "renames_columns": true,
            "type_conversions": true
          }
        },
        {
          "name": "save_data",
          "docstring": "Save cost impact DataFrame to CSV.",
          "args": [
            "df",
            "filepath"
          ],
          "line": 159,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "main",
          "docstring": null,
          "args": [],
          "line": 168,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        }
      ],
      "imports": [
        "sys",
        "pathlib",
        "pandas",
        "config.column_mappings"
      ],
      "pandas_operations": [
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'Posting Type'",
          "column": "Posting Type",
          "line": 102,
          "code_snippet": "complex_gr[\"Posting Type\"] = \"GR\""
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'Posting Type'",
          "column": "Posting Type",
          "line": 110,
          "code_snippet": "complex_ir[\"Posting Type\"] = \"IR\""
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'Posting Date'",
          "column": "Posting Date",
          "line": 114,
          "code_snippet": "combined[\"Posting Date\"] = pd.to_datetime(combined[\"Posting Date\"])"
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'Unit Price'",
          "column": "Unit Price",
          "line": 118,
          "code_snippet": "po_df[\"Unit Price\"] = po_df[\"Purchase Value USD\"] / po_df[\"Ordered Quantity\"]"
        },
        {
          "operation": "rename",
          "description": "Renames columns",
          "line": 97,
          "code_snippet": "complex_gr = complex_gr.rename(columns={",
          "column_renames": {
            "GR Posting Date": "Posting Date",
            "GR Effective Quantity": "Posting Qty",
            "GR Amount": "Posting Amount"
          }
        },
        {
          "operation": "rename",
          "description": "Renames columns",
          "line": 105,
          "code_snippet": "complex_ir = complex_ir.rename(columns={",
          "column_renames": {
            "Invoice Posting Date": "Posting Date",
            "IR Effective Quantity": "Posting Qty",
            "Invoice Amount": "Posting Amount"
          }
        },
        {
          "operation": "to_datetime",
          "description": "Converts to datetime",
          "line": 114,
          "code_snippet": "combined[\"Posting Date\"] = pd.to_datetime(combined[\"Posting Date\"])"
        },
        {
          "operation": "sort_values",
          "description": "Sorts by column values",
          "line": 115,
          "code_snippet": "combined = combined.sort_values([\"PO Line ID\", \"Posting Date\", \"Posting Type\"])"
        },
        {
          "operation": "groupby",
          "description": "Groups data for aggregation",
          "line": 124,
          "code_snippet": "for po_line_id, group in combined.groupby(\"PO Line ID\"):",
          "group_column": "PO Line ID"
        },
        {
          "operation": "sort_values",
          "description": "Sorts by column values",
          "line": 195,
          "code_snippet": "all_impact = all_impact.sort_values([\"PO Line ID\", \"Posting Date\"])"
        }
      ],
      "line_count": 206
    },
    {
      "name": "06_prepare_po_line_items",
      "path": "scripts/stage3_prepare/06_prepare_po_line_items.py",
      "stage": "stage3_prepare",
      "docstring": "Stage 3: Prepare PO Line Items for Import\n\nMaps intermediate columns to database schema columns and calculates\nderived fields (open_po_qty, open_po_value).\n\nDependencies: All stage1 and stage2 scripts must run first\nInput: data/intermediate/po_line_items.csv, data/intermediate/cost_impact.csv\nOutput: data/import-ready/po_line_items.csv",
      "inputs": [
        "data/intermediate/po_line_items.csv",
        "data/intermediate/cost_impact.csv"
      ],
      "outputs": [
        "data/intermediate/po_line_items.csv",
        "data/intermediate/cost_impact.csv"
      ],
      "dependencies": [
        "07_prepare_po_transactions"
      ],
      "functions": [
        {
          "name": "load_data",
          "docstring": "Load intermediate data files.",
          "args": [],
          "line": 30,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "calculate_open_values",
          "docstring": "Calculate open_po_qty and open_po_value based on cost impact.\n\nLogic:\n- If raw status is CLOSED PO: trust it, set open_po_qty and open_po_value to 0\n- Otherwise: calculate open values from ordered - cost impact",
          "args": [
            "po_df",
            "cost_df"
          ],
          "line": 43,
          "semantics": {
            "modifies_columns": [
              "Total Cost Impact Qty",
              "Total Cost Impact Amount"
            ],
            "filters_data": true,
            "aggregates": true,
            "joins_data": true,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "map_columns",
          "docstring": "Map CSV columns to database column names.",
          "args": [
            "po_df"
          ],
          "line": 92,
          "semantics": {
            "modifies_columns": [
              "open_po_qty",
              "open_po_value",
              "fmt_po"
            ],
            "filters_data": true,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "validate_output",
          "docstring": "Validate required columns are present.",
          "args": [
            "df"
          ],
          "line": 123,
          "semantics": {
            "modifies_columns": [],
            "filters_data": true,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "save_data",
          "docstring": "Save import-ready DataFrame to CSV.",
          "args": [
            "df",
            "filepath"
          ],
          "line": 142,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "main",
          "docstring": null,
          "args": [],
          "line": 151,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        }
      ],
      "imports": [
        "sys",
        "pathlib",
        "pandas",
        "config.column_mappings"
      ],
      "pandas_operations": [
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'Total Cost Impact Qty'",
          "column": "Total Cost Impact Qty",
          "line": 64,
          "code_snippet": "po_df[\"Total Cost Impact Qty\"] = po_df[\"Total Cost Impact Qty\"].fillna(0)"
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'Total Cost Impact Amount'",
          "column": "Total Cost Impact Amount",
          "line": 65,
          "code_snippet": "po_df[\"Total Cost Impact Amount\"] = po_df[\"Total Cost Impact Amount\"].fillna(0)"
        },
        {
          "operation": "merge",
          "description": "Joins two DataFrames",
          "line": 61,
          "code_snippet": "po_df = po_df.merge(cost_agg, on=\"PO Line ID\", how=\"left\")",
          "on_column": "PO Line ID",
          "join_type": "left"
        },
        {
          "operation": "fillna",
          "description": "Fills null values",
          "line": 64,
          "code_snippet": "po_df[\"Total Cost Impact Qty\"] = po_df[\"Total Cost Impact Qty\"].fillna(0)"
        },
        {
          "operation": "fillna",
          "description": "Fills null values",
          "line": 65,
          "code_snippet": "po_df[\"Total Cost Impact Amount\"] = po_df[\"Total Cost Impact Amount\"].fillna(0)"
        },
        {
          "operation": "drop",
          "description": "Removes columns or rows",
          "line": 87,
          "code_snippet": "po_df = po_df.drop(columns=[\"Total Cost Impact Qty\", \"Total Cost Impact Amount\"])",
          "dropped_columns": [
            "Total Cost Impact Qty",
            "Total Cost Impact Amount"
          ]
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'open_po_qty'",
          "column": "open_po_qty",
          "line": 107,
          "code_snippet": "output_df[\"open_po_qty\"] = po_df[\"open_po_qty\"].round(4)"
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'open_po_value'",
          "column": "open_po_value",
          "line": 109,
          "code_snippet": "output_df[\"open_po_value\"] = po_df[\"open_po_value\"].round(2)"
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'fmt_po'",
          "column": "fmt_po",
          "line": 115,
          "code_snippet": "output_df[\"fmt_po\"] = is_ops_vendor"
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'fmt_po'",
          "column": "fmt_po",
          "line": 117,
          "code_snippet": "output_df[\"fmt_po\"] = False"
        },
        {
          "operation": "boolean_filter",
          "description": "Filters rows based on boolean condition",
          "line": 101,
          "code_snippet": "output_df[db_col] = po_df[csv_col]"
        },
        {
          "operation": "groupby",
          "description": "Groups data for aggregation",
          "line": 54,
          "code_snippet": "cost_agg = cost_df.groupby(\"PO Line ID\").agg({",
          "group_column": "PO Line ID"
        }
      ],
      "line_count": 186
    },
    {
      "name": "07_prepare_po_transactions",
      "path": "scripts/stage3_prepare/07_prepare_po_transactions.py",
      "stage": "stage3_prepare",
      "docstring": "Stage 3: Prepare PO Transactions for Import\n\nMaps cost impact data to database schema columns for po_transactions table.\n\nDependencies: stage2_transform/05_calculate_cost_impact.py must run first\nInput: data/intermediate/cost_impact.csv\nOutput: data/import-ready/po_transactions.csv",
      "inputs": [
        "data/intermediate/cost_impact.csv"
      ],
      "outputs": [
        "data/intermediate/cost_impact.csv"
      ],
      "dependencies": [],
      "functions": [
        {
          "name": "load_data",
          "docstring": "Load cost impact data.",
          "args": [
            "filepath"
          ],
          "line": 28,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "map_columns",
          "docstring": "Map CSV columns to database column names.",
          "args": [
            "df"
          ],
          "line": 36,
          "semantics": {
            "modifies_columns": [
              "amount",
              "cost_impact_qty",
              "cost_impact_amount",
              "quantity"
            ],
            "filters_data": true,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "validate_output",
          "docstring": "Validate required columns are present.",
          "args": [
            "df"
          ],
          "line": 64,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "save_data",
          "docstring": "Save import-ready DataFrame to CSV.",
          "args": [
            "df",
            "filepath"
          ],
          "line": 85,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "main",
          "docstring": null,
          "args": [],
          "line": 94,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        }
      ],
      "imports": [
        "sys",
        "pathlib",
        "pandas",
        "config.column_mappings"
      ],
      "pandas_operations": [
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'amount'",
          "column": "amount",
          "line": 58,
          "code_snippet": "output_df[\"amount\"] = output_df[\"cost_impact_amount\"]"
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'cost_impact_qty'",
          "column": "cost_impact_qty",
          "line": 50,
          "code_snippet": "output_df[\"cost_impact_qty\"] = output_df[\"cost_impact_qty\"].round(4)"
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'cost_impact_amount'",
          "column": "cost_impact_amount",
          "line": 52,
          "code_snippet": "output_df[\"cost_impact_amount\"] = output_df[\"cost_impact_amount\"].round(2)"
        },
        {
          "operation": "column_assign",
          "description": "Creates/modifies column 'quantity'",
          "column": "quantity",
          "line": 54,
          "code_snippet": "output_df[\"quantity\"] = output_df[\"quantity\"].round(4)"
        },
        {
          "operation": "boolean_filter",
          "description": "Filters rows based on boolean condition",
          "line": 44,
          "code_snippet": "output_df[db_col] = df[csv_col]"
        }
      ],
      "line_count": 123
    },
    {
      "name": "pipeline",
      "path": "scripts/pipeline.py",
      "stage": "scripts",
      "docstring": "Data Pipeline Orchestrator\n\nRuns all data transformation scripts in the correct order to produce\nimport-ready CSV files from raw data.\n\nUsage:\n    python3 scripts/pipeline.py           # Run full pipeline\n    python3 scripts/pipeline.py --stage1  # Run only stage 1\n    python3 scripts/pipeline.py --stage2  # Run stages 1-2\n    python3 scripts/pipeline.py --stage3  # Run all stages (same as full)\n\nPipeline Stages:\n    Stage 1 (Clean):     Raw data \u2192 Intermediate (cleaned)\n    Stage 2 (Transform): Intermediate \u2192 Intermediate (enriched + cost impact)\n    Stage 3 (Prepare):   Intermediate \u2192 Import-ready (DB schema mapped)\n\nOutput:\n    data/import-ready/po_line_items.csv   \u2192 po_line_items table\n    data/import-ready/po_transactions.csv \u2192 po_transactions table",
      "inputs": [],
      "outputs": [],
      "dependencies": [],
      "functions": [
        {
          "name": "run_script",
          "docstring": "Run a Python script and return success status.",
          "args": [
            "script_path",
            "description"
          ],
          "line": 52,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "run_stage",
          "docstring": "Run all scripts in a stage.",
          "args": [
            "stage_name",
            "scripts"
          ],
          "line": 71,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "run_pipeline",
          "docstring": "Run the pipeline up to the specified stage.",
          "args": [
            "max_stage"
          ],
          "line": 89,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        },
        {
          "name": "main",
          "docstring": null,
          "args": [],
          "line": 134,
          "semantics": {
            "modifies_columns": [],
            "filters_data": false,
            "aggregates": false,
            "joins_data": false,
            "renames_columns": false,
            "type_conversions": false
          }
        }
      ],
      "imports": [
        "subprocess",
        "sys",
        "argparse",
        "pathlib",
        "datetime"
      ],
      "pandas_operations": [],
      "line_count": 167
    }
  ],
  "column_mappings": {
    "PO_LINE_ITEMS_MAPPING": {
      "PO Line ID": "po_line_id",
      "PO Number": "po_number",
      "PO Document Date": "po_creation_date",
      "Plant Code": "plant_code",
      "Location": "location",
      "SL Sub-Business Line Code (BV Lvl 3)": "sub_business_line",
      "PR Number": "pr_number",
      "PR Line": "pr_line",
      "Requester": "requester",
      "Main Vendor ID": "vendor_id",
      "Main Vendor Name": "vendor_name",
      "Main Vendor SLB Vendor Category": "vendor_category",
      "Ultimate Vendor Name": "ultimate_vendor_name",
      "PO Line": "line_item_number",
      "PO Material Number": "part_number",
      "PO Material description": "description",
      "Ordered Quantity": "ordered_qty",
      "PO Order Unit": "order_unit",
      "Purchase Value USD": "po_value_usd",
      "PO Account Assignment Category": "account_assignment_category",
      "NIS Line": "nis_line",
      "PO WBS Element": "wbs_number",
      "Asset Code": "asset_code",
      "Expected Delivery Date": "expected_delivery_date",
      "PO Approval Status": "po_approval_status",
      "PO Receipt Status": "po_receipt_status",
      "PO GTS Status": "po_gts_status",
      "FMT PO": "fmt_po",
      "Open PO Qty": "open_po_qty",
      "Open PO Value": "open_po_value"
    },
    "PO_TRANSACTIONS_MAPPING": {
      "PO Line ID": "po_line_id",
      "Posting Type": "transaction_type",
      "Posting Date": "posting_date",
      "Posting Qty": "quantity",
      "Posting Amount": "amount",
      "Cost Impact Qty": "cost_impact_qty",
      "Cost Impact Amount": "cost_impact_amount"
    },
    "VENDOR_NAME_MAPPING": {
      "P9516": "Dubai Hub",
      "P9109": "Houston Hub",
      "P9517": "Shanghai Hub",
      "P9518": "Singapore Hub",
      "P9514": "Canada Hub",
      "P9519": "Japan Hub",
      "P9097": "Rotterdam Hub",
      "P9107": "NAM RDC",
      "P9071": "PPCU",
      "P9052": "SRC",
      "P9057": "SKK",
      "P9060": "SRPC",
      "P9036": "HFE",
      "P9035": "HCS",
      "P9086": "ONESUBSEA",
      "P9064": "PPCS",
      "P9066": "SWTC",
      "P9562": "QRTC",
      "P9032": "FCS"
    },
    "EXCLUDED_NIS_LEVELS": [
      "Compensation Business Delivery",
      "Compensation Business Enablement"
    ],
    "SIMPLE_ACCOUNT_CATEGORIES": [
      "K",
      "P",
      "S",
      "V"
    ]
  },
  "schema_tables": [
    {
      "name": "budget_forecasts",
      "file": "budget-forecasts.ts",
      "columns": [
        {
          "name": "id",
          "type": "uuid",
          "primary_key": true
        },
        {
          "name": "forecastVersionId",
          "type": "uuid",
          "not_null": true,
          "references": "forecastVersions.id"
        },
        {
          "name": "costBreakdownId",
          "type": "uuid",
          "not_null": true,
          "references": "costBreakdown.id"
        },
        {
          "name": "forecastedCost",
          "type": "numeric",
          "not_null": true,
          "has_default": true
        },
        {
          "name": "createdAt",
          "type": "timestamp"
        }
      ],
      "extraction_method": "ts-ast"
    },
    {
      "name": "cost_breakdown",
      "file": "cost-breakdown.ts",
      "columns": [
        {
          "name": "id",
          "type": "uuid",
          "primary_key": true
        },
        {
          "name": "projectId",
          "type": "uuid",
          "not_null": true,
          "references": "projects.id"
        },
        {
          "name": "subBusinessLine",
          "type": "text",
          "not_null": true
        },
        {
          "name": "costLine",
          "type": "text",
          "not_null": true
        },
        {
          "name": "spendType",
          "type": "text",
          "not_null": true
        },
        {
          "name": "spendSubCategory",
          "type": "text",
          "not_null": true
        },
        {
          "name": "budgetCost",
          "type": "numeric",
          "not_null": true,
          "has_default": true
        },
        {
          "name": "createdAt",
          "type": "timestamp"
        },
        {
          "name": "updatedAt",
          "type": "timestamp"
        }
      ],
      "extraction_method": "ts-ast"
    },
    {
      "name": "forecast_versions",
      "file": "forecast-versions.ts",
      "columns": [
        {
          "name": "id",
          "type": "uuid",
          "primary_key": true
        },
        {
          "name": "projectId",
          "type": "uuid",
          "not_null": true,
          "references": "projects.id"
        },
        {
          "name": "versionNumber",
          "type": "integer",
          "not_null": true
        },
        {
          "name": "reasonForChange",
          "type": "text",
          "not_null": true
        },
        {
          "name": "createdAt",
          "type": "timestamp"
        },
        {
          "name": "createdBy",
          "type": "text",
          "has_default": true
        }
      ],
      "extraction_method": "ts-ast"
    },
    {
      "name": "po_line_items",
      "file": "po-line-items.ts",
      "columns": [
        {
          "name": "id",
          "type": "uuid",
          "primary_key": true
        },
        {
          "name": "poLineId",
          "type": "varchar",
          "not_null": true,
          "unique": true
        },
        {
          "name": "poNumber",
          "type": "varchar",
          "not_null": true
        },
        {
          "name": "poCreationDate",
          "type": "date"
        },
        {
          "name": "plantCode",
          "type": "varchar"
        },
        {
          "name": "location",
          "type": "varchar"
        },
        {
          "name": "subBusinessLine",
          "type": "varchar"
        },
        {
          "name": "prNumber",
          "type": "varchar"
        },
        {
          "name": "prLine",
          "type": "integer"
        },
        {
          "name": "requester",
          "type": "varchar"
        },
        {
          "name": "vendorId",
          "type": "varchar"
        },
        {
          "name": "vendorName",
          "type": "varchar"
        },
        {
          "name": "vendorCategory",
          "type": "varchar"
        },
        {
          "name": "ultimateVendorName",
          "type": "varchar"
        },
        {
          "name": "lineItemNumber",
          "type": "integer",
          "not_null": true
        },
        {
          "name": "partNumber",
          "type": "varchar"
        },
        {
          "name": "description",
          "type": "text"
        },
        {
          "name": "orderedQty",
          "type": "numeric",
          "not_null": true
        },
        {
          "name": "orderUnit",
          "type": "varchar"
        },
        {
          "name": "poValueUsd",
          "type": "numeric",
          "not_null": true
        },
        {
          "name": "accountAssignmentCategory",
          "type": "varchar"
        },
        {
          "name": "nisLine",
          "type": "varchar"
        },
        {
          "name": "wbsNumber",
          "type": "varchar",
          "references": "wbsDetails.wbsNumber"
        },
        {
          "name": "assetCode",
          "type": "varchar"
        },
        {
          "name": "expectedDeliveryDate",
          "type": "date"
        },
        {
          "name": "poApprovalStatus",
          "type": "varchar"
        },
        {
          "name": "poReceiptStatus",
          "type": "varchar"
        },
        {
          "name": "poGtsStatus",
          "type": "varchar"
        },
        {
          "name": "fmtPo",
          "type": "boolean",
          "not_null": true,
          "has_default": true
        },
        {
          "name": "openPoQty",
          "type": "numeric"
        },
        {
          "name": "openPoValue",
          "type": "numeric"
        },
        {
          "name": "createdAt",
          "type": "timestamp"
        },
        {
          "name": "updatedAt",
          "type": "timestamp"
        }
      ],
      "extraction_method": "ts-ast"
    },
    {
      "name": "po_mappings",
      "file": "po-mappings.ts",
      "columns": [
        {
          "name": "id",
          "type": "uuid",
          "primary_key": true
        },
        {
          "name": "poLineItemId",
          "type": "uuid",
          "not_null": true,
          "references": "poLineItems.id"
        },
        {
          "name": "costBreakdownId",
          "type": "uuid",
          "not_null": true,
          "references": "costBreakdown.id"
        },
        {
          "name": "mappedAmount",
          "type": "numeric",
          "not_null": true
        },
        {
          "name": "mappingNotes",
          "type": "text"
        },
        {
          "name": "mappedBy",
          "type": "varchar"
        },
        {
          "name": "mappedAt",
          "type": "timestamp"
        },
        {
          "name": "createdAt",
          "type": "timestamp"
        },
        {
          "name": "updatedAt",
          "type": "timestamp"
        }
      ],
      "extraction_method": "ts-ast"
    },
    {
      "name": "po_operations",
      "file": "po-operations.ts",
      "columns": [
        {
          "name": "id",
          "type": "uuid",
          "primary_key": true
        },
        {
          "name": "poLineItemId",
          "type": "uuid",
          "not_null": true,
          "references": "poLineItems.id"
        },
        {
          "name": "operationType",
          "type": "varchar",
          "not_null": true
        },
        {
          "name": "status",
          "type": "varchar",
          "not_null": true,
          "has_default": true
        },
        {
          "name": "requestedBy",
          "type": "varchar",
          "not_null": true
        },
        {
          "name": "requestedAt",
          "type": "timestamp",
          "not_null": true
        },
        {
          "name": "approvedBy",
          "type": "varchar"
        },
        {
          "name": "approvedAt",
          "type": "timestamp"
        },
        {
          "name": "completedAt",
          "type": "timestamp"
        },
        {
          "name": "reason",
          "type": "text",
          "not_null": true
        },
        {
          "name": "oldValue",
          "type": "jsonb"
        },
        {
          "name": "newValue",
          "type": "jsonb"
        },
        {
          "name": "notes",
          "type": "text"
        },
        {
          "name": "createdAt",
          "type": "timestamp"
        },
        {
          "name": "updatedAt",
          "type": "timestamp"
        }
      ],
      "extraction_method": "ts-ast"
    },
    {
      "name": "po_transactions",
      "file": "po-transactions.ts",
      "columns": [
        {
          "name": "id",
          "type": "uuid",
          "primary_key": true
        },
        {
          "name": "poLineItemId",
          "type": "uuid",
          "not_null": true,
          "references": "poLineItems.id"
        },
        {
          "name": "transactionType",
          "type": "varchar",
          "not_null": true
        },
        {
          "name": "postingDate",
          "type": "date",
          "not_null": true
        },
        {
          "name": "quantity",
          "type": "numeric",
          "not_null": true,
          "has_default": true
        },
        {
          "name": "amount",
          "type": "numeric",
          "not_null": true,
          "has_default": true
        },
        {
          "name": "costImpactQty",
          "type": "numeric",
          "not_null": true,
          "has_default": true
        },
        {
          "name": "costImpactAmount",
          "type": "numeric",
          "not_null": true,
          "has_default": true
        },
        {
          "name": "createdAt",
          "type": "timestamp"
        },
        {
          "name": "updatedAt",
          "type": "timestamp"
        }
      ],
      "extraction_method": "ts-ast"
    },
    {
      "name": "projects",
      "file": "projects.ts",
      "columns": [
        {
          "name": "id",
          "type": "uuid",
          "primary_key": true
        },
        {
          "name": "name",
          "type": "text",
          "not_null": true
        },
        {
          "name": "subBusinessLine",
          "type": "text",
          "not_null": true
        },
        {
          "name": "createdAt",
          "type": "timestamp"
        },
        {
          "name": "updatedAt",
          "type": "timestamp"
        }
      ],
      "extraction_method": "ts-ast"
    },
    {
      "name": "sap_reservations",
      "file": "sap-reservations.ts",
      "columns": [
        {
          "name": "id",
          "type": "uuid",
          "primary_key": true
        },
        {
          "name": "reservationNumber",
          "type": "varchar",
          "not_null": true
        },
        {
          "name": "reservationLineNumber",
          "type": "varchar",
          "not_null": true
        },
        {
          "name": "reservationRequirementDate",
          "type": "date"
        },
        {
          "name": "partNumber",
          "type": "varchar"
        },
        {
          "name": "description",
          "type": "text"
        },
        {
          "name": "reservationQty",
          "type": "numeric"
        },
        {
          "name": "reservationValue",
          "type": "numeric"
        },
        {
          "name": "reservationStatus",
          "type": "varchar"
        },
        {
          "name": "poNumber",
          "type": "varchar"
        },
        {
          "name": "poLineNumber",
          "type": "integer"
        },
        {
          "name": "wbsNumber",
          "type": "varchar",
          "references": "wbsDetails.wbsNumber"
        },
        {
          "name": "assetCode",
          "type": "varchar"
        },
        {
          "name": "assetSerialNumber",
          "type": "varchar"
        },
        {
          "name": "requester",
          "type": "varchar"
        },
        {
          "name": "createdAt",
          "type": "timestamp"
        },
        {
          "name": "updatedAt",
          "type": "timestamp"
        },
        {
          "name": "poLineItemId",
          "type": "uuid",
          "references": "poLineItems.id"
        }
      ],
      "extraction_method": "ts-ast"
    },
    {
      "name": "wbs_details",
      "file": "wbs-details.ts",
      "columns": [
        {
          "name": "wbsNumber",
          "type": "varchar",
          "primary_key": true
        },
        {
          "name": "clientName",
          "type": "text"
        },
        {
          "name": "subBusinessLine",
          "type": "text"
        }
      ],
      "extraction_method": "ts-ast"
    }
  ],
  "data_files": {
    "raw": [
      "po details report.xlsx",
      "invoice table.csv",
      "po line items.csv",
      "gr table.csv"
    ],
    "intermediate": [
      "gr_postings.csv",
      "ir_postings.csv",
      "cost_impact.csv",
      "po_line_items.csv"
    ],
    "import-ready": [
      "po_transactions.csv",
      "po_line_items.csv"
    ]
  },
  "data_profiles": {
    "invoice table.csv": {
      "path": "data/raw/invoice table.csv",
      "columns": [
        "PO Line ID",
        "Invoice Posting Date",
        "IR Effective Quantity"
      ],
      "dtypes": {
        "PO Line ID": "object",
        "Invoice Posting Date": "object",
        "IR Effective Quantity": "float64"
      },
      "sample_row": {
        "PO Line ID": "4581717940-1",
        "Invoice Posting Date": "2023-06-06 00:00:00.000",
        "IR Effective Quantity": 2.0
      },
      "row_count": 66956,
      "null_counts": {}
    },
    "po line items.csv": {
      "path": "data/raw/po line items.csv",
      "columns": [
        "PO Document Date",
        "PO Initial Output Date",
        "SL Sub-Business Line Code (BV Lvl 3)",
        "Plant Code",
        "PO Approval Status",
        "PO Account Assignment Category",
        "PO Account Assignment Category Desc",
        "PO WBS Element",
        "PO Number",
        "PO Line",
        "PO Line ID",
        "PO Material Number",
        "PO Material description",
        "PO Order Unit",
        "PO Valuation Class",
        "PO Valuation Class Desc",
        "NIS Level 0 Desc",
        "PO Invoice Status",
        "PO Receipt Status",
        "PO Delivery Completed Indicator",
        "Main Vendor SLB Vendor Category",
        "Main Vendor ID",
        "Main Vendor Name",
        "Ultimate Vendor Number",
        "Ultimate Vendor Name",
        "PO GTS Status",
        "PO Current Supplier Requested Delivery Date",
        "PO Current Supplier Promised Date",
        "Ordered Quantity",
        "Purchase Value USD",
        "Open Qty"
      ],
      "dtypes": {
        "PO Document Date": "object",
        "PO Initial Output Date": "object",
        "SL Sub-Business Line Code (BV Lvl 3)": "object",
        "Plant Code": "int64",
        "PO Approval Status": "object",
        "PO Account Assignment Category": "object",
        "PO Account Assignment Category Desc": "object",
        "PO WBS Element": "object",
        "PO Number": "int64",
        "PO Line": "int64",
        "PO Line ID": "object",
        "PO Material Number": "object",
        "PO Material description": "object",
        "PO Order Unit": "object",
        "PO Valuation Class": "float64",
        "PO Valuation Class Desc": "object",
        "NIS Level 0 Desc": "object",
        "PO Invoice Status": "object",
        "PO Receipt Status": "object",
        "PO Delivery Completed Indicator": "object",
        "Main Vendor SLB Vendor Category": "object",
        "Main Vendor ID": "object",
        "Main Vendor Name": "object",
        "Ultimate Vendor Number": "object",
        "Ultimate Vendor Name": "object",
        "PO GTS Status": "object",
        "PO Current Supplier Requested Delivery Date": "object",
        "PO Current Supplier Promised Date": "object",
        "Ordered Quantity": "float64",
        "Purchase Value USD": "float64",
        "Open Qty": "float64"
      },
      "sample_row": {
        "PO Document Date": "2022-12-01 00:00:00.000",
        "PO Initial Output Date": "2022-12-01 00:00:00.000",
        "SL Sub-Business Line Code (BV Lvl 3)": "DHT",
        "Plant Code": 3606,
        "PO Approval Status": "Approved",
        "PO Account Assignment Category": "A",
        "PO Account Assignment Category Desc": "SLB Asset Transfer",
        "PO WBS Element": NaN,
        "PO Number": 4581848878,
        "PO Line": 1,
        "PO Line ID": "4581848878-1",
        "PO Material Number": "H710794",
        "PO Material description": "SJB-FB; JOINT, SAFETY, BOWEN, 15K, H2S,~",
        "PO Order Unit": "EA",
        "PO Valuation Class": 7800.0,
        "PO Valuation Class Desc": "Asset",
        "NIS Level 0 Desc": NaN,
        "PO Invoice Status": "Partially Paid",
        "PO Receipt Status": "CLOSED PO",
        "PO Delivery Completed Indicator": "Yes",
        "Main Vendor SLB Vendor Category": "OPS",
        "Main Vendor ID": "P3791",
        "Main Vendor Name": "CIKARANG, 3791",
        "Ultimate Vendor Number": "P3791",
        "Ultimate Vendor Name": "CIKARANG, 3791",
        "PO GTS Status": "PO Not blocked by GTS",
        "PO Current Supplier Requested Delivery Date": "2022-12-09 00:00:00.000",
        "PO Current Supplier Promised Date": "2022-12-12 00:00:00.000",
        "Ordered Quantity": 1.0,
        "Purchase Value USD": 9819.96,
        "Open Qty": 0.0
      },
      "row_count": 64538,
      "null_counts": {
        "PO Initial Output Date": 192,
        "PO Account Assignment Category": 11334,
        "PO Account Assignment Category Desc": 11334,
        "PO WBS Element": 40646,
        "PO Material Number": 49731,
        "PO Valuation Class": 49731,
        "PO Valuation Class Desc": 49731,
        "NIS Level 0 Desc": 13096,
        "PO GTS Status": 106,
        "PO Current Supplier Promised Date": 35248
      }
    },
    "gr table.csv": {
      "path": "data/raw/gr table.csv",
      "columns": [
        "PO Line ID",
        "GR Posting Date",
        "GR Effective Quantity"
      ],
      "dtypes": {
        "PO Line ID": "object",
        "GR Posting Date": "object",
        "GR Effective Quantity": "float64"
      },
      "sample_row": {
        "PO Line ID": "4581717940-1",
        "GR Posting Date": "2023-06-06 00:00:00.000",
        "GR Effective Quantity": 0.0
      },
      "row_count": 79425,
      "null_counts": {}
    },
    "gr_postings.csv": {
      "path": "data/intermediate/gr_postings.csv",
      "columns": [
        "PO Line ID",
        "GR Posting Date",
        "GR Effective Quantity",
        "GR Amount"
      ],
      "dtypes": {
        "PO Line ID": "object",
        "GR Posting Date": "object",
        "GR Effective Quantity": "float64",
        "GR Amount": "float64"
      },
      "sample_row": {
        "PO Line ID": "4581850069-1",
        "GR Posting Date": "2023-01-06 00:00:00.000",
        "GR Effective Quantity": 1.0,
        "GR Amount": 1489.44
      },
      "row_count": 55810,
      "null_counts": {}
    },
    "ir_postings.csv": {
      "path": "data/intermediate/ir_postings.csv",
      "columns": [
        "PO Line ID",
        "Invoice Posting Date",
        "IR Effective Quantity",
        "Invoice Amount"
      ],
      "dtypes": {
        "PO Line ID": "object",
        "Invoice Posting Date": "object",
        "IR Effective Quantity": "float64",
        "Invoice Amount": "float64"
      },
      "sample_row": {
        "PO Line ID": "4581850069-1",
        "Invoice Posting Date": "2022-12-26 00:00:00.000",
        "IR Effective Quantity": 1.0,
        "Invoice Amount": 1489.44
      },
      "row_count": 55519,
      "null_counts": {}
    },
    "cost_impact.csv": {
      "path": "data/intermediate/cost_impact.csv",
      "columns": [
        "PO Line ID",
        "Posting Date",
        "Posting Type",
        "Posting Qty",
        "Cost Impact Qty",
        "Cost Impact Amount"
      ],
      "dtypes": {
        "PO Line ID": "object",
        "Posting Date": "object",
        "Posting Type": "object",
        "Posting Qty": "float64",
        "Cost Impact Qty": "float64",
        "Cost Impact Amount": "float64"
      },
      "sample_row": {
        "PO Line ID": "4581850069-1",
        "Posting Date": "2022-12-26 00:00:00",
        "Posting Type": "IR",
        "Posting Qty": 1.0,
        "Cost Impact Qty": 1.0,
        "Cost Impact Amount": 1489.44
      },
      "row_count": 109586,
      "null_counts": {}
    },
    "po_line_items.csv": {
      "path": "data/import-ready/po_line_items.csv",
      "columns": [
        "po_line_id",
        "po_number",
        "po_creation_date",
        "plant_code",
        "location",
        "sub_business_line",
        "pr_number",
        "requester",
        "vendor_id",
        "vendor_name",
        "vendor_category",
        "ultimate_vendor_name",
        "line_item_number",
        "part_number",
        "description",
        "ordered_qty",
        "order_unit",
        "po_value_usd",
        "account_assignment_category",
        "nis_line",
        "wbs_number",
        "expected_delivery_date",
        "po_approval_status",
        "po_receipt_status",
        "po_gts_status",
        "open_po_qty",
        "open_po_value",
        "fmt_po"
      ],
      "dtypes": {
        "po_line_id": "object",
        "po_number": "int64",
        "po_creation_date": "object",
        "plant_code": "int64",
        "location": "object",
        "sub_business_line": "object",
        "pr_number": "float64",
        "requester": "object",
        "vendor_id": "object",
        "vendor_name": "object",
        "vendor_category": "object",
        "ultimate_vendor_name": "object",
        "line_item_number": "int64",
        "part_number": "object",
        "description": "object",
        "ordered_qty": "float64",
        "order_unit": "object",
        "po_value_usd": "float64",
        "account_assignment_category": "object",
        "nis_line": "object",
        "wbs_number": "object",
        "expected_delivery_date": "object",
        "po_approval_status": "object",
        "po_receipt_status": "object",
        "po_gts_status": "object",
        "open_po_qty": "float64",
        "open_po_value": "float64",
        "fmt_po": "bool"
      },
      "sample_row": {
        "po_line_id": "4791459949-10001",
        "po_number": 4791459949,
        "po_creation_date": "2022-12-01 00:00:00.000",
        "plant_code": 3606,
        "location": "Jandakot",
        "sub_business_line": "TSW",
        "pr_number": NaN,
        "requester": NaN,
        "vendor_id": "1000038084",
        "vendor_name": "BULLIVANTS PTY LIMITED",
        "vendor_category": "3rd Party",
        "ultimate_vendor_name": "BULLIVANTS PTY LIMITED",
        "line_item_number": 10001,
        "part_number": NaN,
        "description": "Service Item",
        "ordered_qty": 1.0,
        "order_unit": "AU",
        "po_value_usd": 1529.17,
        "account_assignment_category": "K",
        "nis_line": "Materials and Supplies",
        "wbs_number": NaN,
        "expected_delivery_date": "2022-12-15 00:00:00.000",
        "po_approval_status": "Approved",
        "po_receipt_status": "CLOSED PO",
        "po_gts_status": "PO Not blocked by GTS",
        "open_po_qty": 0.0,
        "open_po_value": 0.0,
        "fmt_po": false
      },
      "row_count": 57163,
      "null_counts": {
        "pr_number": 37584,
        "requester": 37072,
        "part_number": 47632,
        "account_assignment_category": 9047,
        "wbs_number": 33327,
        "po_gts_status": 64
      }
    },
    "po_transactions.csv": {
      "path": "data/import-ready/po_transactions.csv",
      "columns": [
        "po_line_id",
        "transaction_type",
        "posting_date",
        "quantity",
        "cost_impact_qty",
        "cost_impact_amount",
        "amount"
      ],
      "dtypes": {
        "po_line_id": "object",
        "transaction_type": "object",
        "posting_date": "object",
        "quantity": "float64",
        "cost_impact_qty": "float64",
        "cost_impact_amount": "float64",
        "amount": "float64"
      },
      "sample_row": {
        "po_line_id": "4581850069-1",
        "transaction_type": "IR",
        "posting_date": "2022-12-26 00:00:00",
        "quantity": 1.0,
        "cost_impact_qty": 1.0,
        "cost_impact_amount": 1489.44,
        "amount": 1489.44
      },
      "row_count": 109586,
      "null_counts": {}
    }
  },
  "common_errors": {
    "KeyError": {
      "pattern": "KeyError: '(.+)'",
      "causes": [
        "Column doesn't exist in DataFrame",
        "Previous script in pipeline didn't run",
        "Column name has different casing or spacing"
      ],
      "solutions": [
        "Check column_mappings.py for correct column names",
        "Run full pipeline: python3 scripts/pipeline.py",
        "Use df.columns.tolist() to see actual column names"
      ]
    },
    "MergeError": {
      "pattern": "merge.*dtype",
      "causes": [
        "Join columns have different dtypes (int vs str)",
        "One side has NaN values causing type inference issues"
      ],
      "solutions": [
        "Ensure both join columns are same type: df['col'] = df['col'].astype(str)",
        "Check for nulls before merge: df['col'].isnull().sum()"
      ]
    },
    "FileNotFoundError": {
      "pattern": "No such file or directory.*data/",
      "causes": [
        "Previous pipeline stage didn't run",
        "Raw data files missing"
      ],
      "solutions": [
        "Run earlier stages first: python3 scripts/pipeline.py --stage1",
        "Check data/raw/ for source files"
      ]
    },
    "ValueError_date": {
      "pattern": "time data.*does not match format",
      "causes": [
        "Date column has inconsistent formats",
        "Non-date values in date column"
      ],
      "solutions": [
        "Use pd.to_datetime with errors='coerce'",
        "Check for non-date values: df[pd.to_datetime(df['col'], errors='coerce').isna()]"
      ]
    },
    "SchemaValidationError": {
      "pattern": "column.*not found|missing required column",
      "causes": [
        "Database schema changed but CSV mapping not updated",
        "Column dropped in earlier transformation"
      ],
      "solutions": [
        "Compare column_mappings.py with src/schema/*.ts",
        "Run npm run type-check after schema changes"
      ]
    }
  },
  "key_files": {
    "orchestrator": "scripts/pipeline.py",
    "column_config": "scripts/config/column_mappings.py",
    "schema_dir": "src/schema/"
  },
  "ai_agent_notes": {
    "to_add_new_column": [
      "1. Add column to src/schema/<table>.ts",
      "2. Run npm run db:push",
      "3. Add CSV\u2192DB mapping in scripts/config/column_mappings.py",
      "4. Update relevant stage script to include the column",
      "5. Run python3 scripts/pipeline.py to regenerate data"
    ],
    "to_add_new_transformation": [
      "1. Identify which stage the transformation belongs to",
      "2. Add function to appropriate stage script",
      "3. Update the main() function to call new transformation",
      "4. Test with python3 scripts/pipeline.py"
    ],
    "to_add_new_data_source": [
      "1. Place raw file in data/raw/",
      "2. Create new stage1 script (numbered appropriately)",
      "3. Add to STAGE1_SCRIPTS in pipeline.py",
      "4. Create column mappings if needed for import"
    ]
  }
}